name: Test and publish on release.

on:
  push:
  release:
    types: [published, edited]

# this is such a small project can do it all here
# otherwise might want to require that
jobs:
  build_and_test:
    name: build and test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2-beta
      - run: npm ci
      # test runs with ts-jest, which does not write the transpiled TS to a file,
      # so if the test runs successfully then will
      - run: npm run test
      # need to actually build the dist and if there are changes it will be committed
      # on top of the current commit. this ensures the github repository contains the
      # distribution materials
      - run: npm run build
      - uses: stefanzweifel/git-auto-commit-action@v4
        with:
          # a commit will be made if any files have changed
          commit_message: Updated distribution materials.

  # could create an entire different workflow, but would have to jump through more
  # hoops to ensure that the build/tests passed without rerunning them
  publish:
    if: github.event_name == 'release' && (github.event.action == 'published') &&
      startsWith(github.ref, 'refs/tags/v')
    name: publish on release
    needs: [build_and_test]
    # ensure that it is tagged -- only tagged commits are released
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2-beta
      - run: npm set //registry.npmjs.org/:_authToken ${{ secrets.NPM_TOKEN }}
      - run: npm ci
      - run: npm publish
